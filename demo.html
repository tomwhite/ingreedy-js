<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ingreedy demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        .imgbox {
            display: grid;
            height: 100%;
        }
        .center-fit {
            max-width: 100%;
            max-height: 100vh;
            margin: auto;
        }
    </style>
</head>
<body>
<input type="file" accept="image/*" id="file-input">
<div class="imgbox">
    <img class="center-fit" id="output">
</div>
<textarea id="ingredients_box" rows="20" cols="40"></textarea>
<script>
const fileInput = document.getElementById('file-input');
fileInput.addEventListener('change', (e) => compress(e));

function compress(e) {
  const MAX_WIDTH = 1024;
  const MAX_HEIGHT = 768;
  const fileName = e.target.files[0].name;
  const reader = new FileReader();
  reader.readAsDataURL(e.target.files[0]);
  reader.onload = event => {
    const img = new Image();
    img.src = event.target.result;

    img.onload = () => {
      let width = img.width;
      let height = img.height;

      if (width > height) {
        if (width > MAX_WIDTH) {
          height *= MAX_WIDTH / width;
          width = MAX_WIDTH;
        }
      } else {
        if (height > MAX_HEIGHT) {
          width *= MAX_HEIGHT / height;
          height = MAX_HEIGHT;
        }
      }

      const elem = document.createElement('canvas');
      elem.width = width;
      elem.height = height;
      const ctx = elem.getContext('2d');
      // img.width and img.height will contain the original dimensions
      ctx.drawImage(img, 0, 0, width, height);
      ctx.canvas.toBlob((blob) => {
        const file = new File(
            [blob], fileName, {type: 'image/png', lastModified: Date.now()});
      }, 'image/png', 1);
      const dataUrl = elem.toDataURL('image/png');

      // TODO: pass in callback to give dataUrl to
      document.getElementById('output').src = dataUrl;
      const base64Img = dataUrl.replace('data:image/png;base64,', '');
      makeVisionRequest(
          base64Img, 'AIzaSyC4zxRw4GIxO1RuUAezGwtnBl-KLkfRJ2E',
          function(response) {
            const centerBlock = getCenterBlock(response);
            const text = getTextFromBlock(centerBlock);
            const textArea = document.getElementById('ingredients_box');
            textArea.value = text;
          });
    }, reader.onerror = error => console.log(error);
  };
}

</script>
<script src="src/ocr.js"></script>
</body>
</html>